<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoinTasker Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary-blue: #1976D2; --accent-gold: #FFD700; }
        body { background-color: #111827; color: #d1d5db; font-family: 'Poppins', sans-serif; }
        .sidebar { transition: transform 0.3s ease-in-out; }
        .sidebar-hidden { transform: translateX(-100%); }
        .nav-link.active { background-color: var(--primary-blue); color: white; }
        .stat-card { background-color: #1f2937; border: 1px solid #374151; }
        .page { display: none; } .page.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal { display: none; } .modal.active { display: flex; }
        .btn-sm { padding: 5px 10px; font-size: 0.8rem; border-radius: 5px; border: none; cursor: pointer; color: #fff; margin: 2px; transition: opacity 0.2s; }
        .btn-sm:hover { opacity: 0.8; }
        .btn-edit { background: #3b82f6; } .btn-block { background: #ef4444; } .btn-unblock { background: #22c55e; }
        .btn-approve { background: #22c55e; } .btn-reject { background: #6b7280; } .btn-delete { background: #ef4444; }
        .btn-package { background-color: var(--accent-gold); color: #111827;}
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #4b5563; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #22c55e; }
        input:checked + .slider:before { transform: translateX(26px); }
    </style>
</head>
<body class="text-gray-200">
    <!-- Login View -->
    <div id="login-view" class="min-h-screen flex items-center justify-center bg-gray-900"><div class="w-full max-w-sm p-8 space-y-6 bg-gray-800 rounded-lg shadow-md"><h1 class="text-3xl font-bold text-center text-white">Admin Login</h1><input id="admin-email" type="email" placeholder="Admin Email" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-[var(--primary-blue)]"><input id="admin-password" type="password" placeholder="Password" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-[var(--primary-blue)]"><button id="admin-login-btn" class="w-full py-2 px-4 bg-[var(--primary-blue)] hover:opacity-90 rounded-lg text-white font-semibold">Login</button></div></div>
    
    <!-- Main Dashboard -->
    <div id="dashboard-view" class="hidden">
        <aside class="bg-gray-900 w-64 h-screen fixed hidden lg:block"><div class="p-4 text-2xl font-bold text-white">CoinTasker</div><nav id="desktop-nav" class="mt-8"></nav></aside>
        <div id="mobile-sidebar" class="sidebar sidebar-hidden bg-gray-900 w-64 h-screen fixed z-30 lg:hidden"><div class="p-4 text-2xl font-bold text-white">CoinTasker</div><nav id="mobile-nav" class="mt-8"></nav></div>
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden lg:hidden"></div>
        <div class="lg:ml-64">
            <header class="bg-gray-900 p-4 flex justify-between items-center lg:hidden sticky top-0 z-10"><button id="menu-btn" class="text-white"><i class="fas fa-bars fa-xl"></i></button><h1 id="page-title" class="text-xl font-bold">Dashboard</h1><div></div></header>
            <main class="p-4 md:p-6">
                <div id="dashboard-page" class="page"><h1 class="text-3xl font-bold text-white mb-6 hidden lg:block">Dashboard</h1><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div class="stat-card p-6 rounded-lg"><h2 class="text-gray-400 text-lg">Total Users</h2><p id="total-users" class="text-4xl font-bold mt-2">0</p></div><div class="stat-card p-6 rounded-lg"><h2 class="text-gray-400 text-lg">Pending Withdrawals</h2><p id="pending-withdrawals" class="text-4xl font-bold mt-2">0</p></div><div class="stat-card p-6 rounded-lg"><h2 class="text-gray-400 text-lg">Pending Deposits</h2><p id="pending-deposits" class="text-4xl font-bold mt-2">0</p></div></div></div>
                <div id="users-page" class="page"><h1 class="text-3xl font-bold text-white mb-6 hidden lg:block">User Management</h1><div class="bg-gray-800 shadow-md rounded-lg overflow-x-auto"><table class="min-w-full"><thead class="bg-gray-700"><tr><th class="p-3 text-left">User</th><th class="p-3 text-left">Balance (CT)</th><th class="p-3 text-left">Package</th><th class="p-3 text-left">Invites</th><th class="p-3 text-left">Status</th><th class="p-3 text-left">Actions</th></tr></thead><tbody id="users-table-body" class="divide-y divide-gray-600"></tbody></table></div></div>
                <div id="withdrawals-page" class="page"><h1 class="text-3xl font-bold text-white mb-6 hidden lg:block">Withdrawal Requests</h1><div class="bg-gray-800 shadow-md rounded-lg overflow-x-auto"><table class="min-w-full"><thead class="bg-gray-700"><tr><th class="p-3 text-left">User</th><th class="p-3 text-left">Amount</th><th class="p-3 text-left">Method & Details</th><th class="p-3 text-left">Actions</th></tr></thead><tbody id="requests-table-body" class="divide-y divide-gray-600"></tbody></table></div></div>
                <div id="deposits-page" class="page"><h1 class="text-3xl font-bold text-white mb-6 hidden lg:block">Manual Deposits</h1><div class="bg-gray-800 shadow-md rounded-lg overflow-x-auto"><table class="min-w-full"><thead class="bg-gray-700"><tr><th class="p-3 text-left">User</th><th class="p-3 text-left">Amount (USD)</th><th class="p-3 text-left">Package</th><th class="p-3 text-left">TXID</th><th class="p-3 text-left">Actions</th></tr></thead><tbody id="deposits-table-body" class="divide-y divide-gray-600"></tbody></table></div></div>
                <div id="channels-page" class="page"><h1 class="text-3xl font-bold text-white mb-6 hidden lg:block">Manage Channel Tasks</h1><div class="bg-gray-800 shadow-md rounded-lg p-6 mb-8"><h2 class="text-xl font-semibold mb-4">Add New Channel</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><input id="channel-name" type="text" placeholder="Channel Name" class="bg-gray-700 border border-gray-600 p-2 rounded"><input id="channel-link" type="text" placeholder="Telegram Link (https://t.me/..)" class="bg-gray-700 border border-gray-600 p-2 rounded"><input id="channel-username" type="text" placeholder="Username (@example)" class="bg-gray-700 border border-gray-600 p-2 rounded"><input id="channel-reward" type="number" placeholder="Reward (CT)" class="bg-gray-700 border border-gray-600 p-2 rounded"></div><button id="add-channel-btn" class="mt-4 py-2 px-4 bg-[var(--primary-blue)] hover:opacity-90 rounded text-white font-semibold">Add Channel</button></div><div class="bg-gray-800 shadow-md rounded-lg overflow-x-auto"><table class="min-w-full"><thead class="bg-gray-700"><tr><th class="p-3 text-left">Name</th><th class="p-3 text-left">Reward</th><th class="p-3 text-left">Actions</th></tr></thead><tbody id="channels-table-body" class="divide-y divide-gray-600"></tbody></table></div></div>
                <div id="packages-page" class="page"><h1 class="text-3xl font-bold text-white mb-6 hidden lg:block">Manage Packages</h1><div class="bg-gray-800 shadow-md rounded-lg overflow-x-auto"><table class="min-w-full"><thead class="bg-gray-700"><tr><th class="p-3 text-left">Package Name</th><th class="p-3 text-left">Price (USD)</th><th class="p-3 text-left">Active Users</th><th class="p-3 text-left">Status</th><th class="p-3 text-left">Actions</th></tr></thead><tbody id="packages-table-body" class="divide-y divide-gray-600"></tbody></table></div></div>
            </main>
        </div>
    </div>
    <!-- Modals -->
    <div id="edit-balance-modal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4"><div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6"><h2 class="text-2xl font-bold mb-4">Edit User Balance</h2><p class="mb-2">Editing balance for <strong id="modal-user-name"></strong></p><p class="text-sm text-gray-400 mb-4">Current Balance: <span id="modal-current-balance"></span> CT</p><div class="mb-4"><label class="block mb-2">Amount to Add/Subtract</label><input type="number" id="balance-change-amount" placeholder="e.g., 500 to add, -200 to subtract" class="w-full bg-gray-700 p-2 rounded"></div><div class="flex justify-end gap-4"><button id="cancel-edit-btn" class="py-2 px-4 bg-gray-600 rounded">Cancel</button><button id="save-balance-btn" class="py-2 px-4 bg-[var(--primary-blue)] rounded">Save Changes</button></div></div></div>
    <div id="edit-package-modal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4"><div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6"><h2 class="text-2xl font-bold mb-4">Change User Package</h2><p class="mb-2">For user: <strong id="modal-pkg-user-name"></strong></p><p class="text-sm text-gray-400 mb-4">Current Package: <span id="modal-current-package"></span></p><div class="mb-4"><label for="package-select" class="block mb-2">Select New Package</label><select id="package-select" class="w-full bg-gray-700 p-2 rounded"></select></div><div class="flex justify-end gap-4"><button id="cancel-pkg-btn" class="py-2 px-4 bg-gray-600 rounded">Cancel</button><button id="save-pkg-btn" class="py-2 px-4 bg-[var(--primary-blue)] rounded">Save Changes</button></div></div></div>
    
    <script type="module">
        const firebaseConfig = { apiKey: "AIzaSyDIKjauCf0k3G6FT2ROtHirCcs2mNIeWuQ", authDomain: "cointasker-2.firebaseapp.com", databaseURL: "https://cointasker-2.firebaseio.com", projectId: "cointasker-2", storageBucket: "cointasker-2.appspot.com", messagingSenderId: "802713658402", appId: "1:802713658402:web:8d07e946ecd8819faa167b" };
        const ADMIN_UIDS = ["FMBIIDafKuhe4SXsT8LwO0MelUW2"]; 

        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, collection, doc, updateDoc, onSnapshot, query, where, addDoc, deleteDoc, getDoc, orderBy, increment, runTransaction, Timestamp, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getFirestore(app);
        const loginView = document.getElementById('login-view'); const dashboardView = document.getElementById('dashboard-view');
        
        const navHTML = `
            <a href="#" class="nav-link block py-3 px-4 text-gray-400 hover:bg-gray-700 hover:text-white rounded-md mx-2 my-1" data-page="dashboard-page"><i class="fas fa-tachometer-alt w-6 inline-block"></i> Dashboard</a>
            <a href="#" class="nav-link block py-3 px-4 text-gray-400 hover:bg-gray-700 hover:text-white rounded-md mx-2 my-1" data-page="users-page"><i class="fas fa-users w-6 inline-block"></i> Users</a>
            <a href="#" class="nav-link block py-3 px-4 text-gray-400 hover:bg-gray-700 hover:text-white rounded-md mx-2 my-1" data-page="withdrawals-page"><i class="fas fa-wallet w-6 inline-block"></i> Withdrawals</a>
            <a href="#" class="nav-link block py-3 px-4 text-gray-400 hover:bg-gray-700 hover:text-white rounded-md mx-2 my-1" data-page="deposits-page"><i class="fas fa-arrow-down w-6 inline-block"></i> Deposits</a>
            <a href="#" class="nav-link block py-3 px-4 text-gray-400 hover:bg-gray-700 hover:text-white rounded-md mx-2 my-1" data-page="channels-page"><i class="fab fa-telegram w-6 inline-block"></i> Channels</a>
            <a href="#" class="nav-link block py-3 px-4 text-gray-400 hover:bg-gray-700 hover:text-white rounded-md mx-2 my-1" data-page="packages-page"><i class="fas fa-box-open w-6 inline-block"></i> Packages</a>
            <a href="#" id="admin-logout-btn" class="block py-3 px-4 mt-8 text-gray-400 hover:bg-gray-700 hover:text-white rounded-md mx-2 my-1"><i class="fas fa-sign-out-alt w-6 inline-block"></i> Logout</a>`;
        document.getElementById('desktop-nav').innerHTML = navHTML; document.getElementById('mobile-nav').innerHTML = navHTML;
        
        onAuthStateChanged(auth, (user) => { if (user && ADMIN_UIDS.includes(user.uid)) { loginView.style.display = 'none'; dashboardView.style.display = 'block'; navigateTo('dashboard-page'); } else { loginView.style.display = 'flex'; dashboardView.style.display = 'none'; signOut(auth); } });
        document.getElementById('admin-login-btn').addEventListener('click', async () => { const e = document.getElementById('admin-email').value, p = document.getElementById('admin-password').value; try { await signInWithEmailAndPassword(auth, e, p); } catch (err) { alert("Login Failed: " + err.message); } });
        document.querySelectorAll('#admin-logout-btn').forEach(btn => btn.addEventListener('click', () => signOut(auth)));
        
        const menuBtn = document.getElementById('menu-btn'); const mobileSidebar = document.getElementById('mobile-sidebar'); const overlay = document.getElementById('sidebar-overlay');
        menuBtn.addEventListener('click', () => { mobileSidebar.classList.toggle('sidebar-hidden'); overlay.classList.toggle('hidden'); });
        overlay.addEventListener('click', () => { mobileSidebar.classList.add('sidebar-hidden'); overlay.classList.add('hidden'); });
        
        document.querySelectorAll('.nav-link').forEach(link => link.addEventListener('click', (e) => { e.preventDefault(); navigateTo(e.target.closest('a').dataset.page); mobileSidebar.classList.add('sidebar-hidden'); overlay.classList.add('hidden');}));
        function navigateTo(pageId) { document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); document.getElementById(pageId).classList.add('active'); document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active')); document.querySelectorAll(`.nav-link[data-page="${pageId}"]`).forEach(l=>l.classList.add('active')); document.getElementById('page-title').textContent = pageId.replace('-page', '').replace(/^\w/, c => c.toUpperCase()); if(pageId === 'dashboard-page') loadDashboardData(); if(pageId === 'users-page') loadUsers(); if(pageId === 'withdrawals-page') loadWithdrawalRequests(); if(pageId === 'deposits-page') loadDepositRequests(); if(pageId === 'channels-page') loadChannels(); if(pageId === 'packages-page') loadPackages(); }
        
        function loadDashboardData(){ onSnapshot(collection(db, "users"), snap => { document.getElementById('total-users').textContent = snap.size; }); onSnapshot(query(collection(db, "withdrawals"), where("status", "==", "pending")), snap => { document.getElementById('pending-withdrawals').textContent = snap.size; }); onSnapshot(query(collection(db, "manualDeposits"), where("status", "==", "pending")), snap => { document.getElementById('pending-deposits').textContent = snap.size; });}
        function loadUsers() { onSnapshot(query(collection(db, "users"), orderBy("createdAt", "desc")), (snapshot) => { const tableBody = document.getElementById('users-table-body'); tableBody.innerHTML = ''; snapshot.forEach(docSnap => { const user = docSnap.data(); const isBlocked = user.isBlocked || false; tableBody.innerHTML += `<tr><td class="p-3"><p class="font-bold">${user.firstName}</p><p class="text-sm text-gray-400">@${user.username || 'N/A'}</p></td><td class="p-3">${Math.floor(user.balance || 0)}</td><td class="p-3">${user.activePackage || 'free'}</td><td class="p-3 font-bold">${user.referralCount || 0}</td><td class="p-3"><span class="px-2 text-xs font-semibold rounded-full ${isBlocked ? 'bg-red-500 text-white' : 'bg-green-500 text-white'}">${isBlocked ? 'Blocked' : 'Active'}</span></td><td class="p-3 flex flex-wrap"><button data-id="${docSnap.id}" class="btn-sm btn-edit">Bal</button><button data-id="${docSnap.id}" class="btn-sm btn-package">Pkg</button><button data-id="${docSnap.id}" data-blocked="${isBlocked}" class="btn-sm ${isBlocked ? 'btn-unblock' : 'btn-block'}">${isBlocked ? 'Unblock' : 'Block'}</button></td></tr>`; }); }); }
        function loadWithdrawalRequests() { onSnapshot(query(collection(db, "withdrawals"), where("status", "==", "pending")), (s) => { const t = document.getElementById('requests-table-body'); t.innerHTML = ''; if(s.empty) t.innerHTML=`<tr><td colspan="4" class="text-center p-4 text-gray-500">No pending requests.</td></tr>`; s.forEach(d => { const r = d.data(); t.innerHTML += `<tr><td class="p-3">${r.username}</td><td class="p-3 font-bold text-[var(--accent-gold)]">${r.amount}</td><td class="p-3 text-sm"><p class="font-semibold">${r.method}</p><p class="text-gray-400 break-all">${r.paymentDetail}</p></td><td class="p-3 space-x-2"><button class="btn-sm btn-approve" data-type="withdrawal" data-id="${d.id}" data-user-id="${r.userId}" data-amount="${r.amount}">Approve</button><button class="btn-sm btn-reject" data-type="withdrawal" data-id="${d.id}">Reject</button></td></tr>`; }); }); }
        function loadDepositRequests() { onSnapshot(query(collection(db, "manualDeposits"), where("status", "==", "pending")), (s) => { const t = document.getElementById('deposits-table-body'); t.innerHTML = ''; if(s.empty) t.innerHTML=`<tr><td colspan="5" class="text-center p-4 text-gray-500">No pending requests.</td></tr>`; s.forEach(d => { const r = d.data(); t.innerHTML += `<tr><td class="p-3">${r.username}</td><td class="p-3 font-bold text-green-400">$${r.amount}</td><td class="p-3">${r.packageKey}</td><td class="p-3 text-gray-400 break-all">${r.txid}</td><td class="p-3 space-x-2"><button class="btn-sm btn-approve" data-type="deposit" data-id="${d.id}" data-user-id="${r.userId}" data-package="${r.packageKey}">Approve</button><button class="btn-sm btn-reject" data-type="deposit" data-id="${d.id}">Reject</button></td></tr>`; }); }); }
        function loadChannels() { onSnapshot(collection(db, "channels"), (s) => { const t=document.getElementById('channels-table-body'); t.innerHTML=''; s.forEach(d => { const c = d.data(); t.innerHTML += `<tr><td class="p-3">${c.name}</td><td class="p-3 font-bold text-[var(--accent-gold)]">${c.reward}</td><td class="p-3"><button class="btn-sm btn-delete" data-id="${d.id}">Delete</button></td></tr>`; }); }); }
        async function loadPackages() { onSnapshot(collection(db, "packages"), async (snapshot) => { const tableBody = document.getElementById('packages-table-body'); tableBody.innerHTML = ''; for (const docSnap of snapshot.docs) { const pkg = docSnap.data(); const userCountSnap = await getDocs(query(collection(db, "users"), where("activePackage", "==", docSnap.id))); tableBody.innerHTML += `<tr><td class="p-3 font-bold">${pkg.name}</td><td class="p-3">$${pkg.price}</td><td class="p-3">${userCountSnap.size}</td><td class="p-3"><span class="px-2 text-xs font-semibold rounded-full ${pkg.isActive ? 'bg-green-500' : 'bg-gray-500'}">${pkg.isActive ? 'Active' : 'Inactive'}</span></td><td class="p-3"><label class="toggle-switch"><input type="checkbox" ${pkg.isActive ? 'checked' : ''} data-id="${docSnap.id}" class="toggle-package-status"><span class="slider"></span></label></td></tr>`; } }); }

        document.addEventListener('click', (e) => {
            const target = e.target.closest('button'); if(!target) return;
            const id = target.dataset.id;
            const type = target.dataset.type;
            if (target.matches('.btn-approve')) {
                if (type === 'withdrawal') handleWithdrawal(id, 'approved', target.dataset.userId, target.dataset.amount);
                else if (type === 'deposit') handleDeposit(id, 'approved', target.dataset.userId, target.dataset.package);
            } else if (target.matches('.btn-reject')) {
                if (type === 'withdrawal') handleWithdrawal(id, 'rejected');
                else if (type === 'deposit') handleDeposit(id, 'rejected');
            } else if (target.id === 'add-channel-btn') addChannel();
            else if (target.matches('.btn-delete')) deleteChannel(id);
            else if (target.matches('.btn-edit')) openEditModal(id);
            else if (target.matches('.btn-package')) openPackageModal(id);
            else if (target.matches('.btn-block, .btn-unblock')) toggleBlock(id, target.dataset.blocked === 'true');
        });
        document.addEventListener('change', async (e) => { if (e.target.matches('.toggle-package-status')) { await updateDoc(doc(db, "packages", e.target.dataset.id), { isActive: e.target.checked }); alert(`Package status updated.`); } });
        
        const balanceModal = document.getElementById('edit-balance-modal');
        document.getElementById('cancel-edit-btn').addEventListener('click', () => balanceModal.classList.remove('active'));
        async function openEditModal(userId) { const userSnap = await getDoc(doc(db, "users", userId)); if (userSnap.exists()) { const user = userSnap.data(); document.getElementById('modal-user-name').textContent = user.firstName; document.getElementById('modal-current-balance').textContent = Math.floor(user.balance || 0); document.getElementById('balance-change-amount').value = ''; balanceModal.dataset.userId = userId; balanceModal.classList.add('active'); } }
        document.getElementById('save-balance-btn').addEventListener('click', async () => { const userId = balanceModal.dataset.userId; const changeAmount = parseFloat(document.getElementById('balance-change-amount').value); if (isNaN(changeAmount)) return alert("Invalid number."); await updateDoc(doc(db, "users", userId), { balance: increment(changeAmount) }); alert("Balance updated!"); balanceModal.classList.remove('active'); });

        const packageModal = document.getElementById('edit-package-modal');
        document.getElementById('cancel-pkg-btn').addEventListener('click', () => packageModal.classList.remove('active'));
        async function openPackageModal(userId) {
            const userSnap = await getDoc(doc(db, "users", userId));
            const packagesSnap = await getDocs(collection(db, "packages"));
            if (userSnap.exists()) {
                const user = userSnap.data();
                document.getElementById('modal-pkg-user-name').textContent = user.firstName;
                document.getElementById('modal-current-package').textContent = user.activePackage || 'free';
                const select = document.getElementById('package-select');
                select.innerHTML = '<option value="free">Free</option>';
                packagesSnap.forEach(doc => { select.innerHTML += `<option value="${doc.id}">${doc.data().name}</option>`; });
                packageModal.dataset.userId = userId;
                packageModal.classList.add('active');
            }
        }
        document.getElementById('save-pkg-btn').addEventListener('click', async () => {
            const userId = packageModal.dataset.userId; const newPackageKey = document.getElementById('package-select').value;
            if(!newPackageKey) return alert("Please select a package.");
            const userRef = doc(db, "users", userId); let updateData = { activePackage: newPackageKey };
            if (newPackageKey !== 'free') {
                const pkgSnap = await getDoc(doc(db, "packages", newPackageKey));
                if (pkgSnap.exists()) { const pkg = pkgSnap.data(); const expiryDate = new Date(); expiryDate.setDate(expiryDate.getDate() + pkg.durationDays); updateData.packageExpiry = Timestamp.fromDate(expiryDate); }
            } else { updateData.packageExpiry = null; }
            await updateDoc(userRef, updateData); alert("User package updated!"); packageModal.classList.remove('active');
        });

        async function toggleBlock(userId, isBlocked) { if(!confirm(`Are you sure you want to ${isBlocked ? 'unblock' : 'block'} this user?`)) return; await updateDoc(doc(db, "users", userId), { isBlocked: !isBlocked }); alert(`User ${isBlocked ? 'unblocked' : 'blocked'}.`); }
        async function handleWithdrawal(reqId, status, userId, amount) { const reqRef = doc(db, "withdrawals", reqId); if (status === 'approved') { if (!confirm("IMPORTANT: Have you sent the payment? Approving will deduct the balance.")) return; try { const userRef = doc(db, "users", userId); await runTransaction(db, async (t) => { t.update(userRef, { balance: increment(-parseFloat(amount)) }); t.update(reqRef, { status: 'approved' }); }); alert(`Withdrawal approved.`); } catch (err) { alert("Transaction failed: " + err); } } else { await updateDoc(reqRef, { status: 'rejected' }); alert(`Withdrawal rejected.`); } }
        async function handleDeposit(reqId, status, userId, packageKey) { const reqRef = doc(db, "manualDeposits", reqId); if (status === 'approved') { if (!confirm(`Approve deposit and activate ${packageKey} package for ${userId}?`)) return; const userRef = doc(db, "users", userId); const pkgRef = doc(db, "packages", packageKey); try { const pkgSnap = await getDoc(pkgRef); if(!pkgSnap.exists()) throw `Package '${packageKey}' not found.`; const pkg = pkgSnap.data(); const expiryDate = new Date(); expiryDate.setDate(expiryDate.getDate() + pkg.durationDays); await runTransaction(db, async (t) => { t.update(userRef, { activePackage: packageKey, packageExpiry: Timestamp.fromDate(expiryDate) }); t.update(reqRef, { status: 'approved' }); }); alert("Deposit approved!"); } catch(err) { alert("Error: "+err); } } else { await updateDoc(reqRef, { status: 'rejected' }); alert(`Deposit rejected.`); } }
        async function addChannel() { const name = document.getElementById('channel-name').value.trim(); const link = document.getElementById('channel-link').value.trim(); const username = document.getElementById('channel-username').value.trim(); const reward = parseFloat(document.getElementById('channel-reward').value); if(!name || !link || !username.startsWith('@') || isNaN(reward)) return alert("All fields are required."); try { await addDoc(collection(db, "channels"), { name, link, username, reward }); alert("Channel added!");['channel-name', 'channel-link', 'channel-username', 'channel-reward'].forEach(id => document.getElementById(id).value = ''); } catch (error) { alert("Error: " + error.message); } }
        async function deleteChannel(id) { if(!confirm("Are you sure?")) return; await deleteDoc(doc(db, "channels", id)); }
    </script>
</body>
</html>
